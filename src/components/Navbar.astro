---
export interface Props {
	rounded?: boolean;
}

const lokalgruppen = await Astro.glob('../pages/de/lokalgruppen/*.md*');

const { rounded = true } = Astro.props as Props;

type MenuDefinition = {
	items: MenuItem[];
};

type MenuItem = {
	title: string;
	isMega?: boolean;
	to?: string;
	items?: MenuItem[];
};

const menuItems: MenuDefinition = {
	items: [
		{
			title: 'Verein',
			to: '/de/verein/ueber-uns',
			items: [
				{
					title: 'Archiv',
					to: '/de/news/1',
				},
				{
					title: 'Projektbericht 2024',
					to: '/de/verein/projektbericht',
				},
				{
					title: '√úber uns',
					to: '/de/verein/ueber-uns',
				},
				{
					title: 'Preise / Auszeichnungen',
					to: '/de/verein/preise',
				},
				{
					title: 'F√∂rderungsw√ºrdigkeit',
					to: '/de/verein/foerderungswuerdigkeit',
				},
				{
					title: 'Gesellschaftlicher Auftrag',
					to: '/de/verein/gesellschaftlicher-auftrag',
				},
				{
					title: 'Patner',
					to: '/de/verein/partner',
				},
				{
					title: 'ü†Ü Engagieren!',
					to: '/de/verein/engagieren',
				},
			],
		},
		{
			title: 'Projekte',
			to: '/de/projekte',
			items: [
				{
					title: 'Schulische Pr√§vention',
					to: '/de/projekte/schulische-praevention',
				},
				{
					title: 'Forschung',
					to: '/de/projekte/forschung',
				},
				{
					title: 'Universit√§re Lehre',
					to: '/de/projekte/lehre',
				},
				// {
				// 	title: 'Podcast',
				// 	to: '/de/projekte/podcast',
				// },
			],
		},
		{
			title: 'Lokalgruppen',
			to: '/#lokalgruppen',
			items: lokalgruppen.map((lokalgruppe) => ({
				title: lokalgruppe.frontmatter.title,
				to: lokalgruppe.url,
			})),
		},
		{
			title: 'Wissen',
			to: '/de/wissen',
			isMega: true,
			items: [
				{
					title: 'Krankheiten',
					to: '/de/wissen/krankheiten',
					items: (await Astro.glob('../pages/de/wissen/krankheiten/*.md')).map((page) => ({
						title: page.frontmatter.title,
						to: page.url,
					})),
				},
				{
					title: 'Allgemein',
					to: '/de/wissen/allgemein',
					items: [
						{
							title: 'H√§ufige Fragen',
							to: '/de/wissen/allgemein/faq',
						},
						{
							title: 'Impfen A-Z',
							to: '/de/wissen/allgemein/impfen-a-z',
						},
						{
							title: 'Herdenschutz',
							to: '/de/wissen/allgemein/soziale-verantwortung',
						},
						{
							title: 'Impfmythen widerlegt',
							to: '/de/wissen/allgemein/impfmythen-widerlegt',
						},
						{
							title: 'Wie funktioniert eine Impfung?',
							to: '/de/wissen/allgemein/wie-funktioniert-eine-impfung',
						},
						{
							title: 'Quecksilber (Thiomersal)',
							to: '/de/wissen/allgemein/quecksilber',
						},
						{
							title: 'Aluminium',
							to: '/de/wissen/allgemein/aluminium',
						},
						{
							title: 'Quiz',
							to: '/de/wissen/allgemein/quiz',
						},
					],
				},
			],
		},
	],
};
---

<div class="w-full absolute top-0 navbar">
	<div class={'container mx-auto border-impf border-t-8 bg-white px-5 shadow-md' + (rounded ? ' lg:rounded-b-md' : '')} style="z-index: 1000;">
		<div class="flex flex-col lg:flex-row font-inter">
			<div class="grow lg:grow-0 flex justify-between items-center">
				<a href="/" class="grow py-2 mr-6">
					<img src="/logo-quer-rgb.svg" alt="Impf Dich Logo" width="220" class="max-w-[180px] sm:max-w-[220px]" />
				</a>
				<button
					id="navbar-toggle"
					class="block lg:hidden rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-impf focus:ring-opacity-50 hover:bg-gray-100 transition-colors"
					aria-label="Toggle navigation menu"
					aria-expanded="false"
				>
					<svg fill="currentColor" viewBox="0 0 20 20" class="w-6 h-6">
						<path
							id="menuClosedCaret"
							fill-rule="evenodd"
							d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM9 15a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z"
							clip-rule="evenodd"></path>
						<path
							id="menuOpenCaret"
							class="hidden"
							fill-rule="evenodd"
							d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
							clip-rule="evenodd"></path>
					</svg>
				</button>
			</div>

			<nav class="grow hidden lg:flex flex-col lg:flex-row items-stretch lg:items-center justify-between menu-toggle pb-4 lg:pb-0">
				<div class="flex flex-col lg:flex-row w-full lg:w-auto">
					{
						menuItems.items.map((item) => {
							if (item.items && !item.isMega && item.items.length > 0) {
								return (
									<div class="navbar-item-dropdown relative w-full lg:w-auto">
										<div class="navbar-item flex justify-between items-center">
											<span>{item.title}</span>
											<svg fill="currentColor" viewBox="0 0 20 20" class="inline w-4 h-4 transition-transform duration-200 transform text-impf mobile-dropdown-arrow">
												<path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
											</svg>
										</div>
										<div class="navbar-dropdown w-full lg:absolute lg:w-64 origin-top-left rounded-md shadow-md">
											<div class="py-2 bg-white lg:rounded-md lg:shadow border-l-4 lg:border-l-0 border-gray-200 lg:border-0">
												{item.items.map((subitem) => (
													<a href={subitem.to} class="navbar-dropdown-item">
														{subitem.title}
													</a>
												))}
											</div>
										</div>
									</div>
								);
							} else if (item.items && item.isMega) {
								return (
									<div class="navbar-item-dropdown relative w-full lg:w-auto">
										<div class="navbar-item flex justify-between items-center">
											<span>{item.title}</span>
											<svg fill="currentColor" viewBox="0 0 20 20" class="inline w-4 h-4 transition-transform duration-200 transform text-impf mobile-dropdown-arrow">
												<path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
											</svg>
										</div>
										<div class="navbar-dropdown navbar-mega-dropdown w-full lg:absolute origin-top-left rounded-md shadow-md">
											<div class="flex flex-col lg:flex-row py-2 bg-white lg:rounded-md lg:shadow gap-3 border-l-4 lg:border-l-0 border-gray-200 lg:border-0 lg:min-w-[500px]">
												{item.items.map((subitem) => (
													<div class="grow lg:min-w-[200px]">
														<h3 class="text-lg lg:text-xl mb-2 ml-4 font-heading text-impf-2">{subitem.title}</h3>
														{subitem.items &&
															subitem.items.map((subsubitem) => (
																<a href={subsubitem.to} class="navbar-dropdown-item">
																	{subsubitem.title}
																</a>
															))}
													</div>
												))}
											</div>
										</div>
									</div>
								);
							} else if (!item.items || item.items.length == 0) {
								return (
									<a class="navbar-item w-full lg:w-auto" href={item.to}>
										{item.title}
									</a>
								);
							}
						})
					}
				</div>
				<div class="w-full lg:w-auto mt-4 lg:mt-0">
					<a href="/de/meta/unterstuetzen" class="rounded bg-impf hover:bg-sky-600 text-white py-2 px-4 flex gap-2 items-center justify-center cursor-pointer transition-colors">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
							<path
								d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"
							></path>
						</svg>
						Unterst√ºtzen
					</a>
				</div>
			</nav>
		</div>
	</div>
</div>

<script>
	document.addEventListener('astro:page-load', function () {
		let menuState = false;
		const toggle = document.querySelectorAll('.menu-toggle');
		const menuOpenCaret = document.querySelector('#menuOpenCaret')!;
		const menuClosedCaret = document.querySelector('#menuClosedCaret')!;
		const navbarToggle = document.querySelector('#navbar-toggle')!;

		// Main menu toggle
		navbarToggle.addEventListener('click', toggleMenu);

		function toggleMenu() {
			menuState = !menuState;
			navbarToggle.setAttribute('aria-expanded', menuState.toString());

			if (menuState) {
				menuOpenCaret.classList.remove('hidden');
				menuClosedCaret.classList.add('hidden');
				toggle.forEach((el) => {
					el.classList.remove('hidden');
				});
			} else {
				menuOpenCaret.classList.add('hidden');
				menuClosedCaret.classList.remove('hidden');
				toggle.forEach((el) => {
					el.classList.add('hidden');
				});
				// Close all mobile dropdowns when closing main menu
				closeAllMobileDropdowns();
			}
		}

		// Mobile dropdown functionality
		function setupMobileDropdowns() {
			const dropdownItems = document.querySelectorAll('.navbar-item-dropdown');

			dropdownItems.forEach((dropdown) => {
				const navbarItem = dropdown.querySelector('.navbar-item');
				const dropdownMenu = dropdown.querySelector('.navbar-dropdown');
				const arrow = dropdown.querySelector('.mobile-dropdown-arrow');

				if (navbarItem && dropdownMenu && arrow) {
					navbarItem.addEventListener('click', (e) => {
						// Only handle mobile dropdown clicks on mobile
						if (window.innerWidth < 1024) {
							e.preventDefault();
							toggleMobileDropdown(dropdown as HTMLElement, dropdownMenu as HTMLElement, arrow as HTMLElement);
						}
					});
				}
			});
		}

		function toggleMobileDropdown(dropdown: HTMLElement, dropdownMenu: HTMLElement, arrow: HTMLElement) {
			const isOpen = dropdownMenu.classList.contains('mobile-dropdown-open');

			// Close all other dropdowns first
			closeAllMobileDropdowns();

			if (!isOpen) {
				dropdownMenu.classList.add('mobile-dropdown-open');
				arrow.style.transform = 'rotate(180deg)';
			}
		}

		function closeAllMobileDropdowns() {
			const allDropdowns = document.querySelectorAll('.navbar-dropdown');
			const allArrows = document.querySelectorAll('.mobile-dropdown-arrow');

			allDropdowns.forEach((dropdown) => {
				dropdown.classList.remove('mobile-dropdown-open');
			});

			allArrows.forEach((arrow) => {
				(arrow as HTMLElement).style.transform = 'rotate(0deg)';
			});
		}

		// Initialize mobile dropdowns
		setupMobileDropdowns();

		// Close mobile menu when clicking outside
		document.addEventListener('click', (e) => {
			const navbar = document.querySelector('.navbar');
			if (navbar && !navbar.contains(e.target as Node) && menuState) {
				toggleMenu();
			}
		});

		// Handle window resize
		window.addEventListener('resize', () => {
			if (window.innerWidth >= 1024) {
				// Reset mobile menu state on desktop
				if (menuState) {
					toggleMenu();
				}
				closeAllMobileDropdowns();
			}
		});
	});
</script>

<style is:global>
	@reference '../style/main.css';

	.navbar-item {
		@apply hover:text-impf transition-colors px-6 py-5 hover:bg-gray-100 cursor-pointer;
	}

	/* Desktop hover behavior */
	@media (min-width: 1024px) {
		.navbar-item-dropdown:hover svg {
			transform: rotate(180deg);
		}

		.navbar-item-dropdown:hover .navbar-dropdown,
		.navbar-dropdown:hover {
			display: block;
		}

		.navbar-dropdown {
			display: none;
			z-index: 1000;
		}

		/* Mega menu specific styling */
		.navbar-mega-dropdown {
			left: 50%;
			transform: translateX(-50%);
			min-width: 500px;
			max-width: 600px;
		}

		/* Ensure mega menu has proper spacing */
		.navbar-mega-dropdown .flex {
			@apply px-4;
		}

		.navbar-mega-dropdown h3 {
			@apply border-b border-gray-200 pb-2 mb-3;
		}
	}

	/* Mobile dropdown behavior */
	@media (max-width: 1023px) {
		.navbar-dropdown {
			display: none;
			z-index: 1000;
		}

		.navbar-dropdown.mobile-dropdown-open {
			display: block;
		}

		.navbar-item {
			@apply border-b border-gray-100 text-left;
		}

		.navbar-item:last-child {
			@apply border-b-0;
		}

		/* Better mobile spacing */
		.menu-toggle {
			@apply pt-4;
		}

		/* Improve mega menu on mobile */
		.navbar-dropdown .flex {
			@apply flex-col;
		}

		/* Mobile mega menu styling */
		.navbar-mega-dropdown h3 {
			@apply border-b border-gray-300 pb-2 mb-2 text-base font-semibold;
		}
	}

	.navbar-dropdown-item {
		@apply block px-4 py-2 text-sm bg-transparent text-gray-900 hover:text-impf hover:bg-gray-100 focus:bg-gray-200 focus:outline-none break-keep whitespace-nowrap;
	}

	/* Smooth transitions */
	.navbar-dropdown {
		transition: all 0.2s ease-in-out;
	}

	.mobile-dropdown-arrow {
		transition: transform 0.2s ease-in-out;
	}

	/* Ensure proper z-index stacking */
	.navbar {
		position: relative;
		z-index: 50;
	}

	.navbar-dropdown {
		z-index: 60;
	}

	/* Prevent mega menu from extending too far right */
	@media (min-width: 1024px) {
		.navbar-mega-dropdown {
			right: auto;
		}

		/* Adjust if the mega menu would go off screen */
		.navbar-item-dropdown:last-child .navbar-mega-dropdown,
		.navbar-item-dropdown:nth-last-child(2) .navbar-mega-dropdown {
			left: auto;
			right: 0;
			transform: none;
		}
	}
</style>
