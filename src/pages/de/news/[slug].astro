---
import Page from '@/layouts/Page.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import dayjs from 'dayjs';
import 'dayjs/locale/de';

dayjs.locale('de');

interface Props {
	entry: CollectionEntry<'news'>;
}

export async function getStaticPaths() {
	const posts = await getCollection('news');

	return posts.map((entry) => ({
		params: {
			slug: entry.data.slug,
		},
		props: {
			entry,
		},
	}));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

// Get all posts for navigation
const allPosts = await getCollection('news');
allPosts.sort((a, b) => {
	const dateA = a.data.publishedAt instanceof Date ? a.data.publishedAt : new Date(String(a.data.publishedAt));
	const dateB = b.data.publishedAt instanceof Date ? b.data.publishedAt : new Date(String(b.data.publishedAt));
	return dateB.getTime() - dateA.getTime();
});

const currentIndex = allPosts.findIndex((post) => post.data.slug === entry.data.slug);
const previousPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
const nextPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
---

<Page content={entry} title={entry.data.title}>
	<!-- Article Header -->
	<div class="mb-8">
		<!-- Article Meta -->
		<div class="mb-6">
			<time class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-50 text-impf">
				<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
				</svg>
				{dayjs(entry.data.publishedAt).format('DD. MMMM YYYY')}
			</time>
		</div>

		<!-- Hero Image -->
		{
			entry.data.heroImage && (
				<div class="mb-8 rounded-xl overflow-hidden shadow-lg">
					<Image src={entry.data.heroImage} alt={entry.data.title} class="w-full h-auto" />
				</div>
			)
		}
	</div>

	<!-- Article Content -->
	<div class="prose prose-lg max-w-none">
		<Content />
	</div>

	<!-- Article Navigation -->
	<div class="mt-12 pt-8 border-t border-gray-200">
		<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
			<!-- Previous Article -->
			{
				previousPost && (
					<div class="group">
						<p class="text-sm font-medium text-gray-500 mb-2 flex items-center">
							<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
							</svg>
							Vorheriger Artikel
						</p>
						<a href={`/de/news/${previousPost.data.slug}`} class="block p-4 rounded-lg border border-gray-200 hover:border-impf hover:shadow-md transition-all duration-200">
							<h3 class="font-heading font-semibold text-gray-900 group-hover:text-impf transition-colors line-clamp-2">{previousPost.data.title}</h3>
							<p class="text-sm text-gray-500 mt-1">{dayjs(previousPost.data.publishedAt).format('DD. MMMM YYYY')}</p>
						</a>
					</div>
				)
			}

			<!-- Next Article -->
			{
				nextPost && (
					<div class={`group ${!previousPost ? 'md:col-start-2' : ''}`}>
						<p class="text-sm font-medium text-gray-500 mb-2 flex items-center md:justify-end">
							Nächster Artikel
							<svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
							</svg>
						</p>
						<a href={`/de/news/${nextPost.data.slug}`} class="block p-4 rounded-lg border border-gray-200 hover:border-impf hover:shadow-md transition-all duration-200">
							<h3 class="font-heading font-semibold text-gray-900 group-hover:text-impf transition-colors line-clamp-2 md:text-right">{nextPost.data.title}</h3>
							<p class="text-sm text-gray-500 mt-1 md:text-right">{dayjs(nextPost.data.publishedAt).format('DD. MMMM YYYY')}</p>
						</a>
					</div>
				)
			}
		</div>

		<!-- Back to News List -->
		<div class="mt-8 pt-6 border-t border-gray-100">
			<a href="/de/news" class="inline-flex items-center text-impf hover:text-impfhover font-medium transition-colors duration-200 group">
				<svg class="w-4 h-4 mr-2 transition-transform duration-200 group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
				</svg>
				Zurück zur Übersicht
			</a>
		</div>
	</div>
</Page>
